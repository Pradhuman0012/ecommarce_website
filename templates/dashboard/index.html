{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="container-fluid px-4 py-4">

  <!-- HEADER + FILTER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-1">Dashboard</h3>
      <div class="text-muted">
        Showing: <strong>{{ label }}</strong>
      </div>
    </div>

    <!-- FILTER FORM -->
    <form method="get" class="d-flex gap-2 align-items-end">

      <!-- MODE -->
      <select name="mode"
              class="form-select"
              onchange="this.form.submit()">
        <option value="day" {% if mode == "day" %}selected{% endif %}>
          Day
        </option>
        <option value="month" {% if mode == "month" %}selected{% endif %}>
          Month
        </option>
        <option value="year" {% if mode == "year" %}selected{% endif %}>
          Year
        </option>
      </select>

      <!-- DAY -->
      {% if mode == "day" %}
        <input type="date"
               name="date"
               value="{{ selected_date }}"
               class="form-control"
               onchange="this.form.submit()">
      {% endif %}

      <!-- MONTH -->
      {% if mode == "month" %}
        <select name="month" class="form-select">
          {% for m in months %}
            <option value="{{ m }}"
              {% if m == selected_month %}selected{% endif %}>
              {{ m }}
            </option>
          {% endfor %}
        </select>

        <input type="number"
               name="year"
               value="{{ selected_year }}"
               class="form-control"
               placeholder="Year">

        <button class="btn btn-primary">
          Apply
        </button>
      {% endif %}

      <!-- YEAR -->
      {% if mode == "year" %}
        <input type="number"
               name="year"
               value="{{ selected_year }}"
               class="form-control"
               placeholder="Year"
               onchange="this.form.submit()">
      {% endif %}

    </form>
  </div>

  <!-- KPI ROW 1 -->
  <div class="row g-4 mb-4">

    <div class="col-lg-4">
      <div class="dashboard-card p-4 rounded-3 h-100">
        <div class="text-muted small mb-1">Total Revenue</div>
        <div class="fs-2 fw-bold">
          ₹{{ total_sales|floatformat:2 }}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="dashboard-card p-4 rounded-3 h-100">
        <div class="text-muted small mb-1">Total Bills</div>
        <div class="fs-2 fw-bold">
          {{ total_bills }}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="dashboard-card p-4 rounded-3 h-100">
        <div class="text-muted small mb-1">Items Sold</div>
        <div class="fs-2 fw-bold">
          {{ total_qty }}
        </div>
      </div>
    </div>

  </div>

  <!-- KPI ROW 2 -->
  <div class="row g-4 mb-4">

    <div class="col-lg-4">
      <div class="dashboard-card p-4 rounded-3 h-100">
        <div class="text-muted small mb-1">Average Bill</div>
        <div class="fs-4 fw-semibold">
          ₹{{ avg_bill|floatformat:2 }}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="dashboard-card p-4 rounded-3 h-100">
        <div class="text-muted small mb-1">GST Collected</div>
        <div class="fs-4 fw-semibold">
          ₹{{ total_gst|floatformat:2 }}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="dashboard-card p-4 rounded-3 h-100">
        <div class="text-muted small mb-1">Discount Given</div>
        <div class="fs-4 fw-semibold text-danger">
          − ₹{{ total_discount|floatformat:2 }}
        </div>
      </div>
    </div>

  </div>

  <!-- TOP ITEMS -->
  <div class="dashboard-card rounded-3 p-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="fw-bold mb-0">Top Selling Items</h6>
    </div>

    {% if top_items %}
      <div class="table-responsive">
        <table class="table table-sm mb-0 theme-table">
          <thead>
            <tr class="small">
              <th>Item</th>
              <th class="text-center">Qty</th>
              <th class="text-end">Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% for i in top_items %}
              <tr>
                <td class="fw-medium">{{ i.item__name }}</td>
                <td class="text-center">{{ i.qty }}</td>
                <td class="text-end fw-semibold">
                  ₹{{ i.revenue|floatformat:2 }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted small">No sales yet.</div>
    {% endif %}

  </div>

</div>
{% endblock %}
