{% extends "base.html" %}
{% block title %}Create Bill{% endblock %}

{% block styleblock %}
/* ==============================
   BASE CARDS & TABLE
   ============================== */
.total-card {
  background: var(--bg-soft);
  border: 1px solid var(--border-soft);
  border-radius: 8px;
}

.table th {
  background: var(--bg-soft);
  text-transform: uppercase;
  font-size: 0.8rem;
  letter-spacing: 0.03em;
}

/* ==============================
   TYPOGRAPHY
   ============================== */
.total-label {
  font-weight: 700;
  font-size: 1.05rem;
}

.total-value {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--accent);
}

.item-name {
  font-size: 0.95rem;
  font-weight: 600;
}

.item-notes {
  font-size: 0.8rem;
  color: #6b7280;
}

/* ==============================
   ADD ITEM SECTION
   ============================== */
.item-add-section {
  border: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.item-add-section label {
  font-size: 0.85rem;
}

/* Controls sizing */
#itemQty {
  height: 36px;
  font-size: 0.9rem;
}

.item-add-section .btn {
  font-size: 0.95rem;
  padding: 8px;
}

/* ==============================
   BILL ITEMS TABLE
   ============================== */
#billItems td:nth-child(4) {
  text-align: center;
}

#billItems button {
  font-size: 1rem;
}

/* ==============================
   STICKY ACTION BAR (POS)
   ============================== */
.pos-action-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-card);
  border-top: 1px solid var(--border-soft);
  padding: 10px;
  z-index: 1030;
}

/* Desktop override */
@media (min-width: 992px) {
  .pos-action-bar {
    position: static;
    padding: 0;
    border: none;
  }
}

/* ==============================
   MOBILE TUNING
   ============================== */
@media (max-width: 992px) {
  .item-add-section .row > div {
    margin-bottom: 6px;
  }
}

/* ==============================
   SELECT2 – POS SMOOTH SEARCH
   ============================== */

/* Container */
.select2-container--default .select2-selection--single {
  height: 38px;
  border: 1px solid var(--border-soft);
  border-radius: 6px;
  padding: 4px 10px;
  background: #fff;
  display: flex;
  align-items: center;
}

/* Selected text */
.select2-container--default .select2-selection__rendered {
  font-size: 0.95rem;
  color: #111;
  line-height: normal;
  padding-left: 0;
}

/* Arrow */
.select2-container--default .select2-selection__arrow {
  height: 100%;
}

/* Focus state (smooth, not jumpy) */
.select2-container--default.select2-container--focus
.select2-selection--single {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
}

/* Dropdown */
.select2-dropdown {
  border-radius: 8px;
  border: 1px solid var(--border-soft);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  animation: selectFade 0.12s ease-out;
}

/* Search input inside dropdown */
.select2-search__field {
  height: 36px;
  font-size: 0.95rem;
  padding: 6px 10px;
  border-radius: 6px;
}

/* Options */
.select2-results__option {
  font-size: 0.95rem;
  padding: 8px 10px;
}

/* Hover / selected */
.select2-results__option--highlighted {
  background: var(--accent);
  color: #fff;
}

/* Animation */
@keyframes selectFade {
  from {
    opacity: 0;
    transform: translateY(-4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.select2-container--default .select2-selection--single:focus {
  outline: none;
}

/* Normalize row height */
.table td,
.table th {
  vertical-align: middle;
  padding: 10px 12px;
}

/* Prevent row jump when notes appear */
.item-name {
  margin-bottom: 2px;
}

.item-notes {
  line-height: 1.2;
}

.badge {
  font-weight: 500;
  font-size: 0.8rem;
}

#billItems button {
  opacity: 0.6;
}

#billItems button:hover {
  opacity: 1;
}

#billItems td:last-child button {
  width: 28px;
  height: 28px;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02);
}
{% endblock %}

{% block body %}
<div class="container-fluid mt-2">
<h2 class="mb-4">Create New Bill</h2>

  <form method="post" id="billingForm">
    {% csrf_token %}

    <!-- CUSTOMER -->
    <div class="card p-3 mb-3">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Customer Name</label>
          <input type="text" name="customer_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">Mobile Number</label>
          <input type="text" name="customer_phone" class="form-control" required>
        </div>
      </div>
    </div>

    <!-- ADD ITEM -->
    <div class="card p-3 mb-3 item-add-section">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-bold">Item</label>
          <select id="itemSelect" class="form-control">
            <option value="">Search item...</option>
            {% for item in items %}
            <option value="{{ item.id }}"
              data-sizes='[
                {% for s in item.sizes.all %}
                {
                  "size": "{{ s.size }}",
                  "label": "{{ s.get_size_display }}",
                  "price": "{{ s.price }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]'>
              {{ item.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label fw-bold">Size</label>
          <select id="itemSize" class="form-select" disabled>
            <option value="">Select size</option>
          </select>
        </div>

        <div class="col-md-1">
          <label class="form-label fw-bold">Qty</label>
          <input type="number" id="itemQty" class="form-control" value="1" min="1">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Notes</label>
          <input type="text"
                maxlength="120"
                id="itemNotes"
                class="form-control"
                placeholder="e.g. extra cheese, less sugar">
        </div>

        <div class="col-md-2">
          <button type="button"
                  class="btn btn-accent w-100 fw-bold"
                  onclick="addItem()">
            + ADD ITEM
          </button>
        </div>
      </div>
    </div>

    <!-- ITEMS TABLE -->
    <div class="card mb-3">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width:32%">Item</th>
              <th style="width:10%">Size</th>
              <th style="width:12%" class="text-end">Price</th>
              <th style="width:12%" class="text-center">Qty</th>
              <th style="width:14%" class="text-end">Total</th>
              <th style="width:6%" class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="billItems"></tbody>
        </table>
      </div>
    </div>

    <!-- PAYMENT + DISCOUNT -->
    <div class="row g-3">
      <div class="col-lg-8 col-md-7">
        <div class="card p-3 h-100">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label fw-bold">Discount (%)</label>
              <input type="number"
                     id="discount"
                     name="discount_percent"
                     class="form-control"
                     value="0"
                     min="0"
                     max="100">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Payment Mode</label>
              <select id="payment_mode" name="payment_mode" class="form-select">
                <option value="UPI">UPI / Digital</option>
                <option value="CASH">Cash</option>
              </select>
            </div>

            <div class="col-md-6 d-none" id="cashReceivedBox">
              <label class="form-label">Cash Received</label>
              <input type="number"
                     id="cashReceived"
                     class="form-control"
                     placeholder="0.00">
            </div>

            <div class="col-md-6 d-none" id="changeBox">
              <label class="form-label">Return Change</label>
              <input type="text"
                     id="changeAmount"
                     class="form-control fw-bold text-success"
                     readonly
                     value="₹ 0.00">
            </div>

          </div>
        </div>
      </div>

      <!-- TOTAL CARD -->
      <div class="col-lg-4 col-md-5 position-sticky"
       style="top:80px;">
        <div class="card p-3 total-card h-100">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <span class="fw-bold">₹ <span id="subtotal">0.00</span></span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>Discount</span>
            <span class="text-danger fw-bold">
              - ₹ <span id="discount-amount">0.00</span>
            </span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>GST ({{ gst_percentage }})</span>
            <span class="fw-bold">₹ <span id="gst">0.00</span></span>
          </div>

          <hr>

          <div class="d-flex justify-content-between align-items-center">
            <span class="total-label">GRAND TOTAL</span>
            <span class="total-value">₹ <span id="grand-total">0.00</span></span>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" name="items_payload" id="itemsPayload">
  </br>
    <div class="pos-action-bar">
      <button type="button"
        class="btn btn-accent btn-lg w-100 fw-bold py-3"
        onclick="submitBill()">
        GENERATE BILL
        <span class="ms-2">₹ <span id="grand-total-clone">0.00</span></span>
      </button>
    </div>

  </form>
</div>

<script>
(function () {
  window.bill = {};
  const GST_PERCENTAGE = Number("{{ gst_percentage }}");

  function init() {
    if (typeof jQuery === "undefined") {
      return setTimeout(init, 50);
    }

    // ITEM SELECT
    $("#itemSelect").select2({
      width: "100%",
      placeholder: "Search item...",
      allowClear: true,
      dropdownAutoWidth: true
    }).on("change", function () {
      const sizeSelect = document.getElementById("itemSize");
      sizeSelect.innerHTML = '<option value="">Select size</option>';
      sizeSelect.disabled = true;

      const option = this.options[this.selectedIndex];
      if (!option?.dataset.sizes) return;

      JSON.parse(option.dataset.sizes).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.size;
        opt.dataset.price = s.price;
        opt.textContent = `${s.label} (₹${s.price})`;
        sizeSelect.appendChild(opt);
      });

      sizeSelect.disabled = false;
    });

    // DISCOUNT
    $("#discount").on("input", renderBill);

    // ✅ FIX: PAYMENT MODE HANDLER
    $("#payment_mode").on("change", function () {
      const isCash = this.value === "CASH";
      $("#cashReceivedBox, #changeBox").toggleClass("d-none", !isCash);

      if (!isCash) {
        $("#cashReceived").val("");
        $("#changeAmount").val("₹ 0.00");
      }
    });

    // CASH CHANGE CALCULATION
    $("#cashReceived").on("input", function () {
      const cash = parseFloat(this.value) || 0;
      const total = parseFloat($("#grand-total").text()) || 0;
      $("#changeAmount").val(`₹ ${Math.max(cash - total, 0).toFixed(2)}`);
    });
  }

  init();

  window.addItem = function () {
    const itemId = $("#itemSelect").val();
    const itemName = $("#itemSelect option:selected").text().trim();
    const sizeSelect = document.getElementById("itemSize");
    const size = sizeSelect.value;
    const sizeLabel = sizeSelect.options[sizeSelect.selectedIndex]?.text.split("(")[0].trim();
    const price = parseFloat($("#itemSize option:selected").data("price"));
    const qty = parseInt($("#itemQty").val(), 10);
    const notes = $("#itemNotes").val().trim();

    if (!itemId || !size || isNaN(price) || qty <= 0) {
      alert("Select item details");
      return;
    }

    const key = `${itemId}_${size}`;
    if (bill[key]) {
      bill[key].qty += qty;
      if (notes) {
        bill[key].notes = notes;
      }
    } else {
      bill[key] = {
        item_id: itemId,
        name: itemName,
        size: size,
        size_label: sizeLabel,
        price,
        qty,
        notes
      };
    }
    renderBill();
    $("#itemNotes").val("");
    $("#itemSelect").val(null).trigger("change").focus();
    $("#itemQty").val(1);

  };

  window.updateQty = function (key, val) {
    bill[key].qty = parseInt(val, 10) || 1;
    renderBill();
  };

  window.removeItem = function (key) {
    delete bill[key];
    renderBill();
  };

  function renderBill() {
    let subtotal = 0;
    $("#billItems").html("");

    Object.entries(bill).forEach(([key, i]) => {
      const rowTotal = i.price * i.qty;
      subtotal += rowTotal;

      $("#billItems").append(`
      <tr>
        <td>
          <div class="item-name">${i.name}</div>
          ${i.notes ? `<div class="item-notes">${i.notes}</div>` : ""}
        </td>
        <td>
          <span class="badge bg-light text-dark border px-2 py-1">
            ${i.size_label}
          </span>
        </td>
        <td class="text-end">₹${i.price.toFixed(2)}</td>
        <td>
          <input type="number"
                min="1"
                value="${i.qty}"
                class="form-control form-control-sm text-center"
                oninput="updateQty('${key}', this.value)">
        </td>
        <td class="text-end fw-bold">₹${rowTotal.toFixed(2)}</td>
        <td class="text-center">
          <button type="button"
                  class="btn btn-sm btn-link text-danger p-0"
                  onclick="removeItem('${key}')">
            ✕
          </button>
        </td>
      </tr>
    `);
    });

    const discountPercent = +$("#discount").val() || 0;
    const discountAmount = subtotal * discountPercent / 100;
    const taxable = Math.max(subtotal - discountAmount, 0);
    const gst = taxable * GST_PERCENTAGE / 100;

    $("#subtotal").text(subtotal.toFixed(2));
    $("#discount-amount").text(discountAmount.toFixed(2));
    $("#gst").text(gst.toFixed(2));
    $("#grand-total").text((taxable + gst).toFixed(2));
    $("#grand-total-clone").text((taxable + gst).toFixed(2));

    if ($("#payment_mode").val() === "CASH") {
      $("#cashReceived").trigger("input");
    }
  }

  window.submitBill = function () {
    if (!Object.keys(bill).length) {
      alert("Add items first");
      return;
    }
    $("#itemsPayload").val(JSON.stringify(bill));
    document.getElementById("billingForm").submit();
  };
})();
</script>
{% endblock %}
