{% extends "base.html" %}
{% block title %}Create Bill{% endblock %}

{% block styleblock %}
.total-card {
  background: var(--bg-soft);
  border: 1px solid var(--border-soft);
  border-radius: 8px;
}

.total-label {
  font-weight: 700;
  font-size: 1.1rem;
}

.total-value {
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--accent);
}

.table th {
  background: var(--bg-soft);
  text-transform: uppercase;
  font-size: 0.85rem;
}

.item-add-section {
  border: none !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
{% endblock %}

{% block body %}
<div class="container mt-4">
  <h2 class="mb-4">Create New Bill</h2>

  <form method="post">
    {% csrf_token %}

    <!-- CUSTOMER -->
    <div class="card p-3 mb-3">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Customer Name</label>
          <input type="text" name="customer_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">Mobile Number</label>
          <input type="text" name="customer_phone" class="form-control" required>
        </div>
      </div>
    </div>

    <!-- ADD ITEM -->
    <div class="card p-3 mb-3 item-add-section">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-bold">Item</label>
          <select id="itemSelect" class="form-control">
            <option value="">Search item...</option>
            {% for item in items %}
            <option value="{{ item.id }}"
              data-sizes='[
                {% for s in item.sizes.all %}
                {
                  "size": "{{ s.size }}",
                  "label": "{{ s.get_size_display }}",
                  "price": "{{ s.price }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]'>
              {{ item.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Size</label>
          <select id="itemSize" class="form-select" disabled>
            <option value="">Select size</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label fw-bold">Qty</label>
          <input type="number" id="itemQty" class="form-control" value="1" min="1">
        </div>
        

        <div class="col-md-3">
          <button type="button"
                  class="btn btn-accent w-100 fw-bold"
                  onclick="addItem()">
            + ADD ITEM
          </button>
        </div>
      </div>
    </div>

    <!-- ITEMS TABLE -->
    <div class="card mb-3">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width:30%">Item</th>
              <th>Size</th>
              <th class="text-end">Price</th>
              <th class="text-center" style="width:100px">Qty</th>
              <th class="text-end">Total</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="billItems"></tbody>
        </table>
      </div>
    </div>

    <!-- PAYMENT + DISCOUNT -->
    <div class="row g-3">
      <div class="col-md-7">
        <div class="card p-3 h-100">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label fw-bold">Discount (%)</label>
              <input type="number"
                     id="discount"
                     name="discount_percent"
                     class="form-control"
                     value="0"
                     min="0"
                     max="100">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Payment Mode</label>
              <select id="payment_mode" name="payment_mode" class="form-select">
                <option value="UPI">UPI / Digital</option>
                <option value="CASH">Cash</option>
              </select>
            </div>

            <div class="col-md-6 d-none" id="cashReceivedBox">
              <label class="form-label">Cash Received</label>
              <input type="number"
                     id="cashReceived"
                     class="form-control"
                     placeholder="0.00">
            </div>

            <div class="col-md-6 d-none" id="changeBox">
              <label class="form-label">Return Change</label>
              <input type="text"
                     id="changeAmount"
                     class="form-control fw-bold text-success"
                     readonly
                     value="₹ 0.00">
            </div>

          </div>
        </div>
      </div>

      <!-- TOTAL CARD -->
      <div class="col-md-5">
        <div class="card p-3 total-card h-100">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <span class="fw-bold">₹ <span id="subtotal">0.00</span></span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>Discount</span>
            <span class="text-danger fw-bold">
              - ₹ <span id="discount-amount">0.00</span>
            </span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>GST (5%)</span>
            <span class="fw-bold">₹ <span id="gst">0.00</span></span>
          </div>

          <hr>

          <div class="d-flex justify-content-between align-items-center">
            <span class="total-label">GRAND TOTAL</span>
            <span class="total-value">₹ <span id="grand-total">0.00</span></span>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" name="items_payload" id="itemsPayload">

    <button type="button"
            class="btn btn-accent btn-lg w-100 fw-bold mt-4 py-3"
            onclick="submitBill()">
      GENERATE & PRINT
    </button>

  </form>
</div>

<script>
(function () {
  window.bill = {};
  const GST_PERCENTAGE = 5;

  function init() {
    if (typeof jQuery === "undefined") {
      return setTimeout(init, 50);
    }

    // ITEM SELECT
    $("#itemSelect").select2({ width: "100%" }).on("change", function () {
      const sizeSelect = document.getElementById("itemSize");
      sizeSelect.innerHTML = '<option value="">Select size</option>';
      sizeSelect.disabled = true;

      const option = this.options[this.selectedIndex];
      if (!option?.dataset.sizes) return;

      JSON.parse(option.dataset.sizes).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.size;
        opt.dataset.price = s.price;
        opt.textContent = `${s.label} (₹${s.price})`;
        sizeSelect.appendChild(opt);
      });

      sizeSelect.disabled = false;
    });

    // DISCOUNT
    $("#discount").on("input", renderBill);

    // ✅ FIX: PAYMENT MODE HANDLER
    $("#payment_mode").on("change", function () {
      const isCash = this.value === "CASH";
      $("#cashReceivedBox, #changeBox").toggleClass("d-none", !isCash);

      if (!isCash) {
        $("#cashReceived").val("");
        $("#changeAmount").val("₹ 0.00");
      }
    });

    // CASH CHANGE CALCULATION
    $("#cashReceived").on("input", function () {
      const cash = parseFloat(this.value) || 0;
      const total = parseFloat($("#grand-total").text()) || 0;
      $("#changeAmount").val(`₹ ${Math.max(cash - total, 0).toFixed(2)}`);
    });
  }

  init();

  window.addItem = function () {
    const itemId = $("#itemSelect").val();
    const itemName = $("#itemSelect option:selected").text().trim();
    const sizeSelect = document.getElementById("itemSize");
    const size = sizeSelect.value;
    const sizeLabel = sizeSelect.options[sizeSelect.selectedIndex]?.text.split("(")[0].trim();
    const price = parseFloat($("#itemSize option:selected").data("price"));
    const qty = parseInt($("#itemQty").val(), 10);

    if (!itemId || !size || isNaN(price) || qty <= 0) {
      alert("Select item details");
      return;
    }

    const key = `${itemId}_${size}`;
    bill[key] = bill[key]
      ? { ...bill[key], qty: bill[key].qty + qty }
      : { item_id: itemId, name: itemName, size: sizeLabel, price, qty };

    renderBill();
    $("#itemSelect").val(null).trigger("change");
    $("#itemQty").val(1);
  };

  window.updateQty = function (key, val) {
    bill[key].qty = parseInt(val, 10) || 1;
    renderBill();
  };

  window.removeItem = function (key) {
    delete bill[key];
    renderBill();
  };

  function renderBill() {
    let subtotal = 0;
    $("#billItems").html("");

    Object.entries(bill).forEach(([key, i]) => {
      const rowTotal = i.price * i.qty;
      subtotal += rowTotal;

      $("#billItems").append(`
        <tr>
          <td class="fw-bold">${i.name}</td>
          <td><span class="badge bg-light text-dark border">${i.size}</span></td>
          <td class="text-end">₹${i.price.toFixed(2)}</td>
          <td>
            <input type="number" min="1" value="${i.qty}"
              class="form-control form-control-sm text-center"
              oninput="updateQty('${key}', this.value)">
          </td>
          <td class="text-end fw-bold">₹${rowTotal.toFixed(2)}</td>
          <td class="text-center">
            <button type="button" class="btn btn-sm text-danger"
              onclick="removeItem('${key}')">×</button>
          </td>
        </tr>
      `);
    });

    const discountPercent = +$("#discount").val() || 0;
    const discountAmount = subtotal * discountPercent / 100;
    const taxable = Math.max(subtotal - discountAmount, 0);
    const gst = taxable * GST_PERCENTAGE / 100;

    $("#subtotal").text(subtotal.toFixed(2));
    $("#discount-amount").text(discountAmount.toFixed(2));
    $("#gst").text(gst.toFixed(2));
    $("#grand-total").text((taxable + gst).toFixed(2));

    if ($("#payment_mode").val() === "CASH") {
      $("#cashReceived").trigger("input");
    }
  }

  window.submitBill = function () {
    if (!Object.keys(bill).length) {
      alert("Add items first");
      return;
    }
    $("#itemsPayload").val(JSON.stringify(bill));
    document.querySelector("form").submit();
  };
})();
</script>
{% endblock %}