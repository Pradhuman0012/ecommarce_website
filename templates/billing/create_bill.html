{% extends "base.html" %}
{% block title %}Create Bill{% endblock %}

{% block styleblock %}
.total-card {
  background: var(--bg-soft);
  border: 1px solid var(--border-soft);
}

.total-label {
  font-weight: 700;
}

.total-value {
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--accent);
}

{% endblock %}

{% block body %}
<div class="container mt-4">

  <h2 class="mb-4">☕ Create New Bill</h2>

  <form method="post">
    {% csrf_token %}

    <!-- CUSTOMER -->
    <div class="card p-3 mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Customer Name</label>
          <input type="text" name="customer_name" class="form-control form-control-lg" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Mobile Number</label>
          <input type="text" name="customer_phone" class="form-control form-control-lg" required>
        </div>
      </div>
    </div>

    <!-- ADD ITEM -->
    <div class="card p-3 mb-4">
      <div class="row g-3 align-items-end">

        <div class="col-md-5">
          <label class="form-label">Item</label>
          <select id="itemSelect" class="form-control form-control-lg">
            <option value="">Select item</option>
            {% for item in items %}
            <option value="{{ item.id }}" data-sizes='[
              {% for s in item.sizes.all %}
              {
                "size": "{{ s.size }}",
                "label": "{{ s.get_size_display }}",
                "price": "{{ s.price }}"
              }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ]'>{{ item.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Size</label>
          <select id="itemSize" class="form-control form-control-lg" disabled>
            <option value="">Select size</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Qty</label>
          <input type="number" id="itemQty" class="form-control form-control-lg" value="1" min="1">
        </div>

        <div class="col-md-2">
          <button type="button"
                  class="btn btn-accent btn-lg w-100 fw-bold"
                  onclick="addItem()">
            + ADD
          </button>
        </div>

      </div>
    </div>

    <!-- BILL TABLE -->
    <div class="card p-3 mb-4">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Size</th>
              <th class="text-end">Price</th>
              <th class="text-center">Qty</th>
              <th class="text-end">Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="billItems"></tbody>
        </table>
      </div>
    </div>

    <!-- TOTAL -->
    <div class="row g-3 mb-4">

      <div class="col-md-12">
        <label class="form-label">Discount (%)</label>
        <div class="discount-box">
          <input type="number"
                id="discount"
                name="discount_percent"
                class="form-control discount-input"
                value="0"
                min="0"
                max="100">
          
        </div>
      </div>

      <div class="card p-4 total-card">
        <div class="d-flex justify-content-between mb-2 line">
          <span class="label">Subtotal</span>
          <span class="value">₹ <span id="subtotal">0.00</span></span>
        </div>

        <div class="d-flex justify-content-between mb-2 line discount-line">
          <span class="label">Discount</span>
          <span class="value text-danger">
            ₹ <span id="discount-amount">0.00</span>
          </span>
        </div>

        <div class="d-flex justify-content-between mb-3 line">
          <span class="label">GST (5%)</span>
          <span class="value">₹ <span id="gst">0.00</span></span>
        </div>

        <div class="total-divider"></div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <span class="total-label">TOTAL</span>
          <span class="total-value">₹ <span id="grand-total">0.00</span></span>
        </div>
      </div>

    </div>

    <input type="hidden" name="items_payload" id="itemsPayload">

    <!-- SUBMIT -->
    <div class="d-grid mb-5">
      <button type="button"
              class="btn btn-accent btn-lg fw-bold py-3"
              onclick="submitBill()">
        GENERATE BILL & PRINT
      </button>
    </div>

  </form>
</div>


{% block scripts %}
<script>
(function waitForJquery() {
  if (typeof window.jQuery === "undefined") {
    // jQuery not ready yet → wait
    setTimeout(waitForJquery, 50);
    return;
  }

  window.bill = {};
  var GST_PERCENTAGE = 5;

  // INIT SELECT2
  $("#itemSelect").select2({
    placeholder: "Search item...",
    width: "100%",
    minimumResultsForSearch: 0
  });

  // ITEM CHANGE → SIZE LOAD
  $("#itemSelect").on("change", function () {
    const sizeSelect = document.getElementById("itemSize");
    sizeSelect.innerHTML = '<option value="">Select size</option>';
    sizeSelect.disabled = true;

    const option = this.options[this.selectedIndex];
    if (!option || !option.dataset.sizes) return;

    const sizes = JSON.parse(option.dataset.sizes);
    sizes.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.size;
      opt.dataset.price = s.price;
      opt.textContent = `${s.label} (₹${s.price})`;
      sizeSelect.appendChild(opt);
    });

    sizeSelect.disabled = false;
  });

  // DISCOUNT LIVE
  $("#discount").on("input", renderBill);

  // FUNCTIONS
  window.addItem = function () {
    const itemSelect = document.getElementById("itemSelect");
    const sizeSelect = document.getElementById("itemSize");
    const qtyInput = document.getElementById("itemQty");

    const itemId = itemSelect.value;
    const itemName = $("#itemSelect option:selected").text();
    const size = sizeSelect.value;
    const price = parseFloat(sizeSelect.selectedOptions[0]?.dataset.price);
    const qty = parseInt(qtyInput.value);

    if (!itemId || !size || isNaN(price) || qty <= 0) {
      alert("Select item, size & quantity properly");
      return;
    }

    const key = `${itemId}_${size}`;
    bill[key] = bill[key]
      ? { ...bill[key], qty: bill[key].qty + qty }
      : { item_id: itemId, name: itemName, size, price, qty };

    renderBill();

    $("#itemSelect").val(null).trigger("change");
    $("#itemSelect").select2("open");

    sizeSelect.innerHTML = '<option value="">Select size</option>';
    sizeSelect.disabled = true;
    qtyInput.value = 1;
  };

  window.removeItem = function (key) {
    delete bill[key];
    renderBill();
  };

  function renderBill() {
    const tbody = document.getElementById("billItems");
    tbody.innerHTML = "";
    let subtotal = 0;

    Object.values(bill).forEach(i => {
      const total = i.price * i.qty;
      subtotal += total;

      tbody.innerHTML += `
        <tr>
          <td>${i.name}</td>
          <td>${i.size}</td>
          <td class="text-end">₹${i.price.toFixed(2)}</td>
          <td class="text-center">
            <input type="number" value="${i.qty}" min="1"
              onchange="this.value=parseInt(this.value)||1; i.qty=this.value; renderBill()">
          </td>
          <td class="text-end">₹${total.toFixed(2)}</td>
          <td>
            <button class="btn btn-sm btn-danger"
              onclick="removeItem('${i.item_id}_${i.size}')">×</button>
          </td>
        </tr>`;
    });

    const discountPercent = +document.getElementById("discount").value || 0;
    const discountAmount = subtotal * discountPercent / 100;
    const taxable = Math.max(subtotal - discountAmount, 0);
    const gst = taxable * GST_PERCENTAGE / 100;

    document.getElementById("subtotal").innerText = subtotal.toFixed(2);
    document.getElementById("discount-amount").innerText = discountAmount.toFixed(2);
    document.getElementById("gst").innerText = gst.toFixed(2);
    document.getElementById("grand-total").innerText = (taxable + gst).toFixed(2);
  }

})();

window.submitBill = function () {
  if (!Object.keys(bill).length) {
    alert("Add at least one item");
    return;
  }
  document.getElementById("itemsPayload").value = JSON.stringify(bill);
  document.querySelector("form").submit();
};
</script>
{% endblock %}
{% endblock %}